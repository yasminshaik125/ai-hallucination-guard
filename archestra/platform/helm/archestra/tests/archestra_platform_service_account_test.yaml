suite: test archestra platform -- ServiceAccount/Role/RoleBinding
templates:
  - serviceaccount.yaml
tests:
  # ServiceAccount tests
  - it: should create a ServiceAccount by default
    documentIndex: 0
    asserts:
      - isKind:
          of: ServiceAccount
      - matchRegex:
          path: metadata.name
          pattern: -archestra-platform$

  - it: should not create ServiceAccount when create is false
    set:
      archestra.orchestrator.kubernetes.serviceAccount.create: false
    asserts:
      - hasDocuments:
          count: 2  # Only Role and RoleBinding should be created

  - it: should use custom ServiceAccount name when provided
    set:
      archestra.orchestrator.kubernetes.serviceAccount.name: "custom-sa-name"
    documentIndex: 0
    asserts:
      - equal:
          path: metadata.name
          value: "custom-sa-name"

  - it: should add custom annotations to ServiceAccount
    set:
      archestra.orchestrator.kubernetes.serviceAccount.annotations:
        eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/my-role"
        custom-annotation: "custom-value"
    documentIndex: 0
    asserts:
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: "arn:aws:iam::123456789012:role/my-role"
      - equal:
          path: metadata.annotations["custom-annotation"]
          value: "custom-value"

  - it: should not have imagePullSecrets when not configured
    documentIndex: 0
    asserts:
      - isNull:
          path: imagePullSecrets

  - it: should add imagePullSecrets to ServiceAccount when configured
    set:
      archestra.orchestrator.kubernetes.serviceAccount.imagePullSecrets:
        - name: myregistrykey
        - name: anotherregistrykey
    documentIndex: 0
    asserts:
      - equal:
          path: imagePullSecrets[0].name
          value: myregistrykey
      - equal:
          path: imagePullSecrets[1].name
          value: anotherregistrykey

  # Role tests
  - it: should create a Role by default
    documentIndex: 1
    asserts:
      - isKind:
          of: Role
      - matchRegex:
          path: metadata.name
          pattern: -archestra-platform-mcp-manager$

  - it: should not create Role when rbac.create is false
    set:
      archestra.orchestrator.kubernetes.rbac.create: false
    asserts:
      - hasDocuments:
          count: 1  # Only ServiceAccount should be created

  - it: should have correct pod permissions in Role
    documentIndex: 1
    asserts:
      - contains:
          path: rules
          content:
            apiGroups: [""]
            resources: ["pods"]
            verbs: ["get", "list", "create", "update", "patch", "delete", "watch"]

  - it: should have pod/exec permissions in Role
    documentIndex: 1
    asserts:
      - contains:
          path: rules
          content:
            apiGroups: [""]
            resources: ["pods/exec"]
            verbs: ["create"]

  - it: should have pod/log permissions in Role
    documentIndex: 1
    asserts:
      - contains:
          path: rules
          content:
            apiGroups: [""]
            resources: ["pods/log"]
            verbs: ["get", "list"]

  - it: should have pod/attach permissions in Role
    documentIndex: 1
    asserts:
      - contains:
          path: rules
          content:
            apiGroups: [""]
            resources: ["pods/attach"]
            verbs: ["get", "create"]

  - it: should have services permissions in Role
    documentIndex: 1
    asserts:
      - contains:
          path: rules
          content:
            apiGroups: [""]
            resources: ["services"]
            verbs: ["get", "list", "create", "update", "patch", "delete", "watch"]

  - it: should have secrets permissions in Role
    documentIndex: 1
    asserts:
      - contains:
          path: rules
          content:
            apiGroups: [""]
            resources: ["secrets"]
            verbs: ["get", "list", "create", "update", "patch", "delete", "watch"]

  - it: should have deployments permissions in Role
    documentIndex: 1
    asserts:
      - contains:
          path: rules
          content:
            apiGroups: ["apps"]
            resources: ["deployments"]
            verbs: ["get", "list", "create", "update", "patch", "delete", "watch"]

  # RoleBinding tests
  - it: should create a RoleBinding by default
    documentIndex: 2
    asserts:
      - isKind:
          of: RoleBinding
      - matchRegex:
          path: metadata.name
          pattern: -archestra-platform-mcp-manager$

  - it: should not create RoleBinding when rbac.create is false
    set:
      archestra.orchestrator.kubernetes.rbac.create: false
    asserts:
      - hasDocuments:
          count: 1  # Only ServiceAccount should be created

  - it: should bind to the correct ServiceAccount
    documentIndex: 2
    asserts:
      - equal:
          path: subjects[0].kind
          value: ServiceAccount
      - matchRegex:
          path: subjects[0].name
          pattern: -archestra-platform$
      - equal:
          path: subjects[0].namespace
          value: NAMESPACE

  - it: should bind to custom ServiceAccount name
    set:
      archestra.orchestrator.kubernetes.serviceAccount.name: "custom-sa-name"
    documentIndex: 2
    asserts:
      - equal:
          path: subjects[0].name
          value: "custom-sa-name"

  - it: should reference the correct Role
    documentIndex: 2
    asserts:
      - equal:
          path: roleRef.kind
          value: Role
      - matchRegex:
          path: roleRef.name
          pattern: -archestra-platform-mcp-manager$
      - equal:
          path: roleRef.apiGroup
          value: rbac.authorization.k8s.io

  # Integration tests
  - it: should create all resources with default values
    asserts:
      - hasDocuments:
          count: 3

  - it: should create only ServiceAccount when RBAC is disabled
    set:
      archestra.orchestrator.kubernetes.rbac.create: false
    asserts:
      - hasDocuments:
          count: 1

  - it: should create only RBAC resources when ServiceAccount is disabled
    set:
      archestra.orchestrator.kubernetes.serviceAccount.create: false
    asserts:
      - hasDocuments:
          count: 2

  - it: should create no resources when both are disabled
    set:
      archestra.orchestrator.kubernetes.serviceAccount.create: false
      archestra.orchestrator.kubernetes.rbac.create: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should work with all custom configurations
    set:
      archestra.orchestrator.kubernetes.serviceAccount.name: "custom-archestra-sa"
      archestra.orchestrator.kubernetes.serviceAccount.annotations:
        eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/archestra-role"
      archestra.orchestrator.kubernetes.serviceAccount.imagePullSecrets:
        - name: private-registry-secret
    documentIndex: 0
    asserts:
      - equal:
          path: metadata.name
          value: "custom-archestra-sa"
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: "arn:aws:iam::123456789012:role/archestra-role"
      - equal:
          path: imagePullSecrets[0].name
          value: private-registry-secret

  - it: should ensure RoleBinding references custom ServiceAccount
    set:
      archestra.orchestrator.kubernetes.serviceAccount.name: "custom-archestra-sa"
    documentIndex: 2
    asserts:
      - equal:
          path: subjects[0].name
          value: "custom-archestra-sa"
