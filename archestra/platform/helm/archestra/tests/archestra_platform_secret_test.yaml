suite: test archestra platform -- Secret
templates:
  - secret.yaml
tests:
  - it: should create auth secret with keep policy and auth-secret key
    asserts:
      - isKind:
          of: Secret
      - matchRegex:
          path: metadata.name
          pattern: -archestra-platform-auth$
      - equal:
          path: type
          value: Opaque
      - equal:
          path: metadata.annotations["helm.sh/resource-policy"]
          value: keep
      - isNotEmpty:
          path: data["auth-secret"]

  - it: should not include database-url when external_database_url is not provided
    set:
      postgresql.external_database_url: null
    asserts:
      - isNull:
          path: data["database-url"]

  - it: should include database-url when external_database_url is provided
    set:
      postgresql.external_database_url: postgresql://external:pass@external-host:5432/externaldb
    asserts:
      - isNotEmpty:
          path: data["database-url"]

  - it: should not include database-url when external_database_url is "from_vault"
    set:
      postgresql.external_database_url: "from_vault"
    asserts:
      - isNull:
          path: data["database-url"]

  # Sensitive environment variable tests
  - it: should not include sensitive env vars in secret when not provided
    set:
      archestra.env: {}
    asserts:
      - isNull:
          path: data["archestra-auth-secret"]
      - isNull:
          path: data["archestra-auth-admin-password"]
      - isNull:
          path: data["archestra-otel-exporter-otlp-auth-password"]
      - isNull:
          path: data["archestra-otel-exporter-otlp-auth-bearer"]
      - isNull:
          path: data["archestra-metrics-secret"]
      - isNull:
          path: data["archestra-hashicorp-vault-token"]

  - it: should include explicit ARCHESTRA_AUTH_SECRET in secret when provided
    set:
      archestra.env:
        ARCHESTRA_AUTH_SECRET: "my-explicit-auth-secret-32-chars!"
    asserts:
      - isNotEmpty:
          path: data["archestra-auth-secret"]

  - it: should include ARCHESTRA_AUTH_ADMIN_PASSWORD in secret when provided
    set:
      archestra.env:
        ARCHESTRA_AUTH_ADMIN_PASSWORD: "my-secure-admin-password"
    asserts:
      - isNotEmpty:
          path: data["archestra-auth-admin-password"]

  - it: should include ARCHESTRA_OTEL_EXPORTER_OTLP_AUTH_PASSWORD in secret when provided
    set:
      archestra.env:
        ARCHESTRA_OTEL_EXPORTER_OTLP_AUTH_PASSWORD: "otel-password-123"
    asserts:
      - isNotEmpty:
          path: data["archestra-otel-exporter-otlp-auth-password"]

  - it: should include ARCHESTRA_OTEL_EXPORTER_OTLP_AUTH_BEARER in secret when provided
    set:
      archestra.env:
        ARCHESTRA_OTEL_EXPORTER_OTLP_AUTH_BEARER: "bearer-token-xyz"
    asserts:
      - isNotEmpty:
          path: data["archestra-otel-exporter-otlp-auth-bearer"]

  - it: should include ARCHESTRA_METRICS_SECRET in secret when provided
    set:
      archestra.env:
        ARCHESTRA_METRICS_SECRET: "metrics-secret-token"
    asserts:
      - isNotEmpty:
          path: data["archestra-metrics-secret"]

  - it: should include ARCHESTRA_HASHICORP_VAULT_TOKEN in secret when provided
    set:
      archestra.env:
        ARCHESTRA_HASHICORP_VAULT_TOKEN: "vault-token-abc123"
    asserts:
      - isNotEmpty:
          path: data["archestra-hashicorp-vault-token"]

  - it: should include multiple sensitive env vars when provided together
    set:
      archestra.env:
        ARCHESTRA_AUTH_ADMIN_PASSWORD: "admin-password"
        ARCHESTRA_METRICS_SECRET: "metrics-secret"
        ARCHESTRA_HASHICORP_VAULT_TOKEN: "vault-token"
    asserts:
      - isNotEmpty:
          path: data["archestra-auth-admin-password"]
      - isNotEmpty:
          path: data["archestra-metrics-secret"]
      - isNotEmpty:
          path: data["archestra-hashicorp-vault-token"]
      # These should still be null since not provided
      - isNull:
          path: data["archestra-otel-exporter-otlp-auth-password"]
      - isNull:
          path: data["archestra-otel-exporter-otlp-auth-bearer"]

  - it: should not include non-sensitive env vars in secret
    set:
      archestra.env:
        ARCHESTRA_INTERNAL_API_BASE_URL: "https://api.example.com"
        ARCHESTRA_FRONTEND_URL: "https://frontend.example.com"
        ARCHESTRA_LOGGING_LEVEL: "debug"
    asserts:
      # Non-sensitive vars should not be stored in the secret
      - isNull:
          path: data["archestra-api-base-url"]
      - isNull:
          path: data["archestra-frontend-url"]
      - isNull:
          path: data["archestra-logging-level"]

  # Empty value edge case tests
  - it: should not include sensitive env vars with empty string values in secret
    set:
      archestra.env:
        ARCHESTRA_METRICS_SECRET: ""
        ARCHESTRA_AUTH_ADMIN_PASSWORD: ""
        ARCHESTRA_HASHICORP_VAULT_TOKEN: ""
    asserts:
      # Empty values should NOT be stored in the secret to avoid invalid secret data
      - isNull:
          path: data["archestra-metrics-secret"]
      - isNull:
          path: data["archestra-auth-admin-password"]
      - isNull:
          path: data["archestra-hashicorp-vault-token"]

  - it: should not include ARCHESTRA_CHAT_*_API_KEY with empty values in secret
    set:
      archestra.env:
        ARCHESTRA_CHAT_ANTHROPIC_API_KEY: ""
        ARCHESTRA_CHAT_OPENAI_API_KEY: ""
    asserts:
      - isNull:
          path: data["archestra-chat-anthropic-api-key"]
      - isNull:
          path: data["archestra-chat-openai-api-key"]

  - it: should handle mix of empty and non-empty sensitive env vars
    set:
      archestra.env:
        ARCHESTRA_METRICS_SECRET: ""
        ARCHESTRA_HASHICORP_VAULT_TOKEN: "valid-token"
    asserts:
      # Empty value should not be in secret
      - isNull:
          path: data["archestra-metrics-secret"]
      # Non-empty value should be in secret
      - isNotEmpty:
          path: data["archestra-hashicorp-vault-token"]

  # ARCHESTRA_CHAT_*_API_KEY pattern matching tests
  - it: should include ARCHESTRA_CHAT_ANTHROPIC_API_KEY in secret when provided
    set:
      archestra.env:
        ARCHESTRA_CHAT_ANTHROPIC_API_KEY: "sk-ant-api-key-123"
    asserts:
      - isNotEmpty:
          path: data["archestra-chat-anthropic-api-key"]

  - it: should include ARCHESTRA_CHAT_OPENAI_API_KEY in secret when provided
    set:
      archestra.env:
        ARCHESTRA_CHAT_OPENAI_API_KEY: "sk-openai-api-key-456"
    asserts:
      - isNotEmpty:
          path: data["archestra-chat-openai-api-key"]

  - it: should include ARCHESTRA_CHAT_GEMINI_API_KEY in secret when provided
    set:
      archestra.env:
        ARCHESTRA_CHAT_GEMINI_API_KEY: "AIza-gemini-api-key-789"
    asserts:
      - isNotEmpty:
          path: data["archestra-chat-gemini-api-key"]

  - it: should include multiple ARCHESTRA_CHAT_*_API_KEY in secret when provided
    set:
      archestra.env:
        ARCHESTRA_CHAT_ANTHROPIC_API_KEY: "sk-ant-key"
        ARCHESTRA_CHAT_OPENAI_API_KEY: "sk-openai-key"
        ARCHESTRA_CHAT_GEMINI_API_KEY: "AIza-key"
    asserts:
      - isNotEmpty:
          path: data["archestra-chat-anthropic-api-key"]
      - isNotEmpty:
          path: data["archestra-chat-openai-api-key"]
      - isNotEmpty:
          path: data["archestra-chat-gemini-api-key"]

  - it: should handle custom ARCHESTRA_CHAT_*_API_KEY providers dynamically
    set:
      archestra.env:
        ARCHESTRA_CHAT_CUSTOM_PROVIDER_API_KEY: "custom-provider-key"
    asserts:
      - isNotEmpty:
          path: data["archestra-chat-custom-provider-api-key"]

  - it: should not include ARCHESTRA_CHAT env vars that dont match *_API_KEY pattern
    set:
      archestra.env:
        ARCHESTRA_CHAT_DEFAULT_MODEL: "claude-opus-4-1-20250805"
    asserts:
      # These don't match the *_API_KEY pattern so should not be in secret
      - isNull:
          path: data["archestra-chat-default-model"]
