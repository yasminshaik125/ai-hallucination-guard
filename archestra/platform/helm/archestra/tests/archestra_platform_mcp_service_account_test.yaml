suite: test archestra platform -- MCP ServiceAccount/Role/RoleBinding/ClusterRoleBinding
templates:
  - mcp-serviceaccount.yaml
tests:
  # ServiceAccount tests
  - it: should create MCP K8s operator ServiceAccount by default
    documentIndex: 0
    asserts:
      - isKind:
          of: ServiceAccount
      - matchRegex:
          path: metadata.name
          pattern: -mcp-k8s-operator$

  - it: should not create any resources when mcpServerRbac.create is false
    set:
      archestra.orchestrator.kubernetes.mcpServerRbac.create: false
    asserts:
      - hasDocuments:
          count: 0

  # Role tests
  - it: should create MCP server operator Role by default
    documentIndex: 1
    asserts:
      - isKind:
          of: Role
      - matchRegex:
          path: metadata.name
          pattern: -mcp-server-operator$

  - it: should have read-only pod permissions in Role
    documentIndex: 1
    asserts:
      - contains:
          path: rules
          content:
            apiGroups: [""]
            resources: ["pods"]
            verbs: ["get", "list", "watch"]

  - it: should have pod/log permissions in Role
    documentIndex: 1
    asserts:
      - contains:
          path: rules
          content:
            apiGroups: [""]
            resources: ["pods/log"]
            verbs: ["get"]

  - it: should have read-only services permissions in Role
    documentIndex: 1
    asserts:
      - contains:
          path: rules
          content:
            apiGroups: [""]
            resources: ["services"]
            verbs: ["get", "list", "watch"]

  - it: should have read-only workload permissions in Role
    documentIndex: 1
    asserts:
      - contains:
          path: rules
          content:
            apiGroups: ["apps"]
            resources:
              ["deployments", "replicasets", "statefulsets", "daemonsets"]
            verbs: ["get", "list", "watch"]

  - it: should have read-only events permissions in Role
    documentIndex: 1
    asserts:
      - contains:
          path: rules
          content:
            apiGroups: [""]
            resources: ["events"]
            verbs: ["get", "list", "watch"]

  # RoleBinding tests
  - it: should create MCP server operator RoleBinding by default
    documentIndex: 2
    asserts:
      - isKind:
          of: RoleBinding
      - matchRegex:
          path: metadata.name
          pattern: -mcp-server-operator$

  - it: should bind to the correct MCP K8s operator ServiceAccount
    documentIndex: 2
    asserts:
      - equal:
          path: subjects[0].kind
          value: ServiceAccount
      - matchRegex:
          path: subjects[0].name
          pattern: -mcp-k8s-operator$
      - equal:
          path: subjects[0].namespace
          value: NAMESPACE

  - it: should reference the correct Role
    documentIndex: 2
    asserts:
      - equal:
          path: roleRef.kind
          value: Role
      - matchRegex:
          path: roleRef.name
          pattern: -mcp-server-operator$
      - equal:
          path: roleRef.apiGroup
          value: rbac.authorization.k8s.io

  # Custom namespace tests
  - it: should use custom namespace when configured
    set:
      archestra.orchestrator.kubernetes.namespace: "custom-namespace"
    documentIndex: 0
    asserts:
      - equal:
          path: metadata.namespace
          value: "custom-namespace"

  - it: should use custom namespace in RoleBinding subject
    set:
      archestra.orchestrator.kubernetes.namespace: "custom-namespace"
    documentIndex: 2
    asserts:
      - equal:
          path: subjects[0].namespace
          value: "custom-namespace"

  # Integration tests
  - it: should create all default resources (ServiceAccount, Role, RoleBinding)
    asserts:
      - hasDocuments:
          count: 3

  # Additional ClusterRoleBinding tests
  - it: should not create ClusterRoleBindings when additionalClusterRoleBindings is empty
    asserts:
      - hasDocuments:
          count: 3

  - it: should create ClusterRoleBinding when additionalClusterRoleBindings is configured
    set:
      archestra.orchestrator.kubernetes.mcpServerRbac.additionalClusterRoleBindings:
        - clusterRoleName: cluster-reader
    asserts:
      - hasDocuments:
          count: 4

  - it: should create multiple ClusterRoleBindings when multiple are configured
    set:
      archestra.orchestrator.kubernetes.mcpServerRbac.additionalClusterRoleBindings:
        - clusterRoleName: cluster-reader
        - clusterRoleName: another-role
    asserts:
      - hasDocuments:
          count: 5

  - it: should create ClusterRoleBinding with auto-generated name
    set:
      archestra.orchestrator.kubernetes.mcpServerRbac.additionalClusterRoleBindings:
        - clusterRoleName: cluster-reader
    documentIndex: 3
    asserts:
      - isKind:
          of: ClusterRoleBinding
      - matchRegex:
          path: metadata.name
          pattern: -mcp-k8s-operator-cluster-reader$

  - it: should create ClusterRoleBinding with custom name when provided
    set:
      archestra.orchestrator.kubernetes.mcpServerRbac.additionalClusterRoleBindings:
        - clusterRoleName: cluster-reader
          name: my-custom-binding-name
    documentIndex: 3
    asserts:
      - isKind:
          of: ClusterRoleBinding
      - equal:
          path: metadata.name
          value: my-custom-binding-name

  - it: should bind ClusterRoleBinding to the correct ServiceAccount
    set:
      archestra.orchestrator.kubernetes.mcpServerRbac.additionalClusterRoleBindings:
        - clusterRoleName: cluster-reader
    documentIndex: 3
    asserts:
      - equal:
          path: subjects[0].kind
          value: ServiceAccount
      - matchRegex:
          path: subjects[0].name
          pattern: -mcp-k8s-operator$
      - equal:
          path: subjects[0].namespace
          value: NAMESPACE

  - it: should reference the correct ClusterRole in ClusterRoleBinding
    set:
      archestra.orchestrator.kubernetes.mcpServerRbac.additionalClusterRoleBindings:
        - clusterRoleName: cluster-reader
    documentIndex: 3
    asserts:
      - equal:
          path: roleRef.kind
          value: ClusterRole
      - equal:
          path: roleRef.name
          value: cluster-reader
      - equal:
          path: roleRef.apiGroup
          value: rbac.authorization.k8s.io

  - it: should use custom namespace in ClusterRoleBinding subject
    set:
      archestra.orchestrator.kubernetes.namespace: "custom-namespace"
      archestra.orchestrator.kubernetes.mcpServerRbac.additionalClusterRoleBindings:
        - clusterRoleName: cluster-reader
    documentIndex: 3
    asserts:
      - equal:
          path: subjects[0].namespace
          value: "custom-namespace"

  - it: should include standard labels in ClusterRoleBinding
    set:
      archestra.orchestrator.kubernetes.mcpServerRbac.additionalClusterRoleBindings:
        - clusterRoleName: cluster-reader
    documentIndex: 3
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/component"]
          value: mcp-serviceaccount

  - it: should not create ClusterRoleBindings when mcpServerRbac.create is false
    set:
      archestra.orchestrator.kubernetes.mcpServerRbac.create: false
      archestra.orchestrator.kubernetes.mcpServerRbac.additionalClusterRoleBindings:
        - clusterRoleName: cluster-reader
    asserts:
      - hasDocuments:
          count: 0

  # Additional RoleBinding tests
  - it: should not create RoleBindings when additionalRoleBindings is empty
    asserts:
      - hasDocuments:
          count: 3

  - it: should create RoleBinding when additionalRoleBindings is configured
    set:
      archestra.orchestrator.kubernetes.mcpServerRbac.additionalRoleBindings:
        - roleName: namespace-admin
          namespace: my-app-namespace
    asserts:
      - hasDocuments:
          count: 4

  - it: should create multiple RoleBindings when multiple are configured
    set:
      archestra.orchestrator.kubernetes.mcpServerRbac.additionalRoleBindings:
        - roleName: namespace-admin
          namespace: my-app-namespace
        - roleName: another-role
          namespace: another-namespace
    asserts:
      - hasDocuments:
          count: 5

  - it: should create RoleBinding with auto-generated name
    set:
      archestra.orchestrator.kubernetes.mcpServerRbac.additionalRoleBindings:
        - roleName: namespace-admin
          namespace: my-app-namespace
    documentIndex: 3
    asserts:
      - isKind:
          of: RoleBinding
      - matchRegex:
          path: metadata.name
          pattern: -mcp-k8s-operator-namespace-admin$

  - it: should create RoleBinding with custom name when provided
    set:
      archestra.orchestrator.kubernetes.mcpServerRbac.additionalRoleBindings:
        - roleName: namespace-admin
          namespace: my-app-namespace
          name: my-custom-rolebinding-name
    documentIndex: 3
    asserts:
      - isKind:
          of: RoleBinding
      - equal:
          path: metadata.name
          value: my-custom-rolebinding-name

  - it: should create RoleBinding in the specified namespace
    set:
      archestra.orchestrator.kubernetes.mcpServerRbac.additionalRoleBindings:
        - roleName: namespace-admin
          namespace: my-app-namespace
    documentIndex: 3
    asserts:
      - equal:
          path: metadata.namespace
          value: my-app-namespace

  - it: should bind RoleBinding to the correct ServiceAccount
    set:
      archestra.orchestrator.kubernetes.mcpServerRbac.additionalRoleBindings:
        - roleName: namespace-admin
          namespace: my-app-namespace
    documentIndex: 3
    asserts:
      - equal:
          path: subjects[0].kind
          value: ServiceAccount
      - matchRegex:
          path: subjects[0].name
          pattern: -mcp-k8s-operator$
      - equal:
          path: subjects[0].namespace
          value: NAMESPACE

  - it: should reference the correct Role in RoleBinding
    set:
      archestra.orchestrator.kubernetes.mcpServerRbac.additionalRoleBindings:
        - roleName: namespace-admin
          namespace: my-app-namespace
    documentIndex: 3
    asserts:
      - equal:
          path: roleRef.kind
          value: Role
      - equal:
          path: roleRef.name
          value: namespace-admin
      - equal:
          path: roleRef.apiGroup
          value: rbac.authorization.k8s.io

  - it: should use custom orchestrator namespace in RoleBinding subject
    set:
      archestra.orchestrator.kubernetes.namespace: "archestra-custom"
      archestra.orchestrator.kubernetes.mcpServerRbac.additionalRoleBindings:
        - roleName: namespace-admin
          namespace: my-app-namespace
    documentIndex: 3
    asserts:
      - equal:
          path: subjects[0].namespace
          value: "archestra-custom"

  - it: should include standard labels in RoleBinding
    set:
      archestra.orchestrator.kubernetes.mcpServerRbac.additionalRoleBindings:
        - roleName: namespace-admin
          namespace: my-app-namespace
    documentIndex: 3
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/component"]
          value: mcp-serviceaccount

  - it: should not create RoleBindings when mcpServerRbac.create is false
    set:
      archestra.orchestrator.kubernetes.mcpServerRbac.create: false
      archestra.orchestrator.kubernetes.mcpServerRbac.additionalRoleBindings:
        - roleName: namespace-admin
          namespace: my-app-namespace
    asserts:
      - hasDocuments:
          count: 0

  - it: should create both ClusterRoleBindings and RoleBindings when both are configured
    set:
      archestra.orchestrator.kubernetes.mcpServerRbac.additionalClusterRoleBindings:
        - clusterRoleName: cluster-reader
      archestra.orchestrator.kubernetes.mcpServerRbac.additionalRoleBindings:
        - roleName: namespace-admin
          namespace: my-app-namespace
    asserts:
      - hasDocuments:
          count: 5
