{{- $secretName := include "archestra-platform.authSecretName" . }}
{{- $secret := lookup "v1" "Secret" .Release.Namespace $secretName }}
{{/*
List of sensitive environment variables that should be stored in the Secret
and referenced via secretKeyRef instead of being exposed as plaintext in Pod specs.
Additionally, any env var matching ARCHESTRA_CHAT_*_API_KEY is treated as sensitive.
*/}}
{{- $sensitiveEnvVars := list
  "ARCHESTRA_AUTH_SECRET"
  "ARCHESTRA_AUTH_ADMIN_PASSWORD"
  "ARCHESTRA_OTEL_EXPORTER_OTLP_AUTH_PASSWORD"
  "ARCHESTRA_OTEL_EXPORTER_OTLP_AUTH_BEARER"
  "ARCHESTRA_METRICS_SECRET"
  "ARCHESTRA_HASHICORP_VAULT_TOKEN"
}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "archestra-platform.labels" . | nindent 4 }}
  annotations:
    "helm.sh/resource-policy": keep
type: Opaque
data:
  {{- if $secret }}
  auth-secret: {{ index $secret.data "auth-secret" }}
  {{- else }}
  auth-secret: {{ randAlphaNum 64 | b64enc }}
  {{- end }}
  {{- if and .Values.postgresql.external_database_url (ne (toString .Values.postgresql.external_database_url) "from_vault") }}
  database-url: {{ .Values.postgresql.external_database_url | b64enc }}
  {{- end }}
  {{/* Store sensitive env vars in the secret if they are provided with non-empty values */}}
  {{- range $sensitiveEnvVars }}
  {{- if hasKey $.Values.archestra.env . }}
  {{- $value := index $.Values.archestra.env . }}
  {{- if $value }}
  {{ . | lower | replace "_" "-" }}: {{ $value | b64enc }}
  {{- end }}
  {{- end }}
  {{- end }}
  {{/* Store any ARCHESTRA_CHAT_*_API_KEY env vars in the secret if non-empty */}}
  {{- range $key, $value := $.Values.archestra.env }}
  {{- if and (hasPrefix "ARCHESTRA_CHAT_" $key) (hasSuffix "_API_KEY" $key) $value }}
  {{ $key | lower | replace "_" "-" }}: {{ $value | b64enc }}
  {{- end }}
  {{- end }}
