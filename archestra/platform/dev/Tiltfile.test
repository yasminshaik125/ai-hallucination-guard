# Test resources

local_resource(
  'unit-tests',
  cmd='pnpm test',
  labels=['test'],
  trigger_mode=TRIGGER_MODE_MANUAL,
  auto_init=False,
  resource_deps=['pnpm-install', 'pnpm-dev-frontend', 'pnpm-dev-backend']
)

local_resource(
  'helm-tests',
  cmd='helm unittest helm/archestra',
  dir='../',
  labels=['test'],
  trigger_mode=TRIGGER_MODE_MANUAL,
  auto_init=False
)

local_resource(
  'e2e-tests',
  cmd='Cnpm test:e2e',
  labels=['test'],
  trigger_mode=TRIGGER_MODE_MANUAL,
  auto_init=False,
  resource_deps=['pnpm-install', 'pnpm-dev-frontend', 'pnpm-dev-backend']
)

local_resource(
  'e2e-tests-ui',
  serve_cmd='pnpm test:e2e:ui',
  serve_dir='../',
  labels=['test'],
  trigger_mode=TRIGGER_MODE_MANUAL,
  auto_init=False,
  resource_deps=['pnpm-install', 'pnpm-dev-frontend', 'pnpm-dev-backend']
)

# E2E test dependencies (WireMock, Keycloak)
# Deploys the e2e-tests helm chart which includes:
#   - WireMock for API mocking
#   - Keycloak for SSO testing with pre-configured test users
#
# Test users are defined in helm/e2e-tests/values.yaml:
#   - admin@example.com (archestra-admins group) - matches default Archestra admin
#   - member@example.com (archestra-users group) - for role mapping tests
#
# The defaults align with Archestra's default admin credentials, so no overrides needed.
load('ext://helm_resource', 'helm_resource')

local_resource(
  'e2e-test-dependencies',
  cmd='helm upgrade --install e2e-tests ../helm/e2e-tests --namespace default --wait',
  labels=['test'],
  trigger_mode=TRIGGER_MODE_MANUAL,
  auto_init=False,
  serve_cmd='kubectl port-forward svc/e2e-tests-wiremock 9092:8080',
)
