name: Platform Linting and Tests

on:
  workflow_call:
    inputs:
      should-skip-running-and-always-succeed:
        description: "Whether to force the checks to succeed"
        required: false
        type: boolean
      is-release-please-pr:
        description: "Whether this is a release-please PR (enables auto-commit of codegen changes)"
        required: false
        type: boolean
        default: false
      is-fork-pr:
        description: "Whether this PR is from a fork (uses artifacts instead of GHCR)"
        required: false
        type: boolean
        default: false
    secrets:
      TURBOREPO_REMOTE_CACHING_TOKEN:
        required: true
      TURBOREPO_REMOTE_CACHING_TEAM:
        required: true
      DOCKER_USERNAME:
        required: true
      DOCKER_PASSWORD:
        required: true
      # Required for release-please PRs to push codegen changes with a token that triggers workflow re-runs
      # (pushes made with GITHUB_TOKEN do not trigger workflows by design)
      # see https://stackoverflow.com/a/67551255
      ARCHESTRA_RELEASER_GITHUB_APP_ID:
        required: false
      ARCHESTRA_RELEASER_GITHUB_APP_PRIVATE_KEY:
        required: false

jobs:
  platform-linting-and-tests:
    name: Platform Linting and Tests
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required for release-please auto-commit of codegen changes
    defaults:
      run:
        working-directory: ./platform
    env:
      TURBO_TOKEN: ${{ secrets.TURBOREPO_REMOTE_CACHING_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBOREPO_REMOTE_CACHING_TEAM }}
    steps:
      # Generate GitHub App token for release-please PRs to push codegen changes
      # (pushes made with GITHUB_TOKEN do not trigger workflows by design)
      - name: Generate token for release-please PR
        if: ${{ inputs.should-skip-running-and-always-succeed != true && inputs.is-release-please-pr == true }}
        id: generate-token
        uses: actions/create-github-app-token@df432ceedc7162793a195dd1713ff69aefc7379e # v2.0.6
        with:
          app-id: ${{ secrets.ARCHESTRA_RELEASER_GITHUB_APP_ID }}
          private-key: ${{ secrets.ARCHESTRA_RELEASER_GITHUB_APP_PRIVATE_KEY }}

      - name: Checkout project
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: ${{ inputs.is-release-please-pr }} # zizmor: ignore[artipacked]
          ref: ${{ inputs.is-release-please-pr && github.head_ref || '' }}
          token: ${{ steps.generate-token.outputs.token || github.token }}

      - name: Setup environment
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: ./.github/actions/setup-env
        continue-on-error: ${{ inputs.should-skip-running-and-always-succeed }}
        with:
          working-directory: ./platform

      - name: Type checking, linting, formatting checks
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: pnpm check:ci

      # Validation checks - codegen, drizzle-kit, db migrations
      - name: Run validation checks (drizzle-kit, codegen, db migrations)
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        env:
          IS_RELEASE_PLEASE_PR: ${{ inputs.is-release-please-pr }}
        run: |
          set -e

          # Start drizzle-kit check in background
          echo "Starting drizzle-kit check in background..."
          (cd backend && pnpm drizzle-kit check) &
          DRIZZLE_PID=$!

          # Run codegen and lint
          echo "Running codegen..."
          pnpm codegen
          pnpm lint:fix

          # Check for codegen changes
          if ! git diff --exit-code || ! git diff --cached --exit-code; then
            if [ "$IS_RELEASE_PLEASE_PR" == "true" ]; then
              echo "ðŸ“¦ Release-please PR with codegen changes detected. Auto-committing..."
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git -C "$GITHUB_WORKSPACE" add docs/ platform/
              git commit -m "chore: update docs/openapi.json version for release"
              git push
              echo "âœ… Changes committed. Workflow will be re-triggered."
              exit 0
            else
              echo "::error::Generated code is not up to date. Please run 'pnpm codegen && pnpm lint:fix' locally and commit the changes."
              exit 1
            fi
          fi
          echo "âœ… Generated code is up to date"

          # Verify no pending database migrations
          echo "Checking for pending database migrations..."
          set +e
          if timeout 15s pnpm db:generate > /tmp/db_generate_output.txt 2>&1; then
            output=$(cat /tmp/db_generate_output.txt)
            echo "$output"
            if echo "$output" | grep -q "â¯\|Is.*table created or renamed"; then
              echo "âŒ Interactive prompt detected - pending database migrations need to be committed"
              exit 1
            fi
          else
            exit_code=$?
            cat /tmp/db_generate_output.txt 2>/dev/null || true
            if [ $exit_code -eq 124 ]; then
              echo "âŒ Command timed out - likely waiting for interactive input about pending migrations"
            else
              echo "âŒ pnpm db:generate failed with exit code $exit_code"
            fi
            exit 1
          fi
          set -e

          # Check for uncommitted migration files
          if ! git diff --exit-code || ! git diff --cached --exit-code; then
            echo "::error::Database schema has changed but migrations are missing. Run 'pnpm db:generate' locally."
            git diff --name-only
            exit 1
          fi
          echo "âœ… No pending database migrations"

          # Wait for drizzle-kit check
          echo "Waiting for drizzle-kit check..."
          if wait "$DRIZZLE_PID"; then
            echo "âœ… drizzle-kit check passed"
          else
            echo "âŒ drizzle-kit check failed"
            exit 1
          fi

          echo "âœ… All validation checks passed"

  # Build Docker images for e2e tests (platform and MCP server base)
  # Non-fork PRs: Push to GHCR (faster)
  # Fork PRs: Upload as artifact (no package write permissions needed)
  platform-e2e-build:
    name: Build ${{ matrix.name }} Image
    runs-on: ${{ matrix.runner }}
    if: ${{ inputs.should-skip-running-and-always-succeed != true }}
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Platform
            runner: blacksmith-16vcpu-ubuntu-2404
            context: ./platform
            dockerfile: ""
            image-name: platform
            artifact-name: platform-docker-image
            tarball-name: platform-image.tar.gz
            local-tag-prefix: archestra-platform
            use-build-action: true
          - name: MCP Server Base
            runner: blacksmith-4vcpu-ubuntu-2404
            context: ./platform/mcp_server_docker_image
            dockerfile: ./platform/mcp_server_docker_image/Dockerfile
            image-name: mcp-server-base
            artifact-name: mcp-server-base-docker-image
            tarball-name: mcp-server-base-image.tar.gz
            local-tag-prefix: mcp-server-base
            use-build-action: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Setup environment
        if: ${{ matrix.use-build-action }}
        uses: ./.github/actions/setup-env
        with:
          working-directory: ./platform

      - name: Login to GHCR
        if: ${{ !inputs.is-fork-pr }}
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Non-fork PRs: Build and push to GHCR (Platform image using custom action)
      - name: Build and push Platform image to GHCR
        if: ${{ !inputs.is-fork-pr && matrix.use-build-action }}
        uses: ./.github/actions/build-platform-docker-image
        with:
          context: ${{ matrix.context }}
          push: "true"
          tags: ghcr.io/${{ github.repository }}/${{ matrix.image-name }}:${{ github.sha }}
          turbo-team: ${{ secrets.TURBOREPO_REMOTE_CACHING_TEAM }}
          turbo-token: ${{ secrets.TURBOREPO_REMOTE_CACHING_TOKEN }}

      # Non-fork PRs: Build and push to GHCR (MCP server base using docker/build-push-action)
      - name: Setup Blacksmith Builder
        if: ${{ !matrix.use-build-action }}
        uses: useblacksmith/setup-docker-builder@f9b57e1c7d5a57eed0b5609e1ffeadbf3bb0b726 # v1.1.0

      - name: Build and push MCP server base image to GHCR
        if: ${{ !inputs.is-fork-pr && !matrix.use-build-action }}
        uses: useblacksmith/build-push-action@30c71162f16ea2c27c3e21523255d209b8b538c1 # v2
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64
          push: true
          tags: ghcr.io/${{ github.repository }}/${{ matrix.image-name }}:${{ github.sha }}

      # Fork PRs: Build locally and export as artifact (Platform image)
      - name: Build Platform image locally
        if: ${{ inputs.is-fork-pr && matrix.use-build-action }}
        uses: ./.github/actions/build-platform-docker-image
        with:
          context: ${{ matrix.context }}
          push: "false"
          load: "true"
          tags: ${{ matrix.local-tag-prefix }}:${{ github.sha }}
          turbo-team: ${{ secrets.TURBOREPO_REMOTE_CACHING_TEAM }}
          turbo-token: ${{ secrets.TURBOREPO_REMOTE_CACHING_TOKEN }}

      # Fork PRs: Build locally and export as artifact (MCP server base)
      - name: Build MCP server base image locally
        if: ${{ inputs.is-fork-pr && !matrix.use-build-action }}
        uses: useblacksmith/build-push-action@30c71162f16ea2c27c3e21523255d209b8b538c1 # v2
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64
          push: false
          load: true
          tags: ${{ matrix.local-tag-prefix }}:${{ github.sha }}

      - name: Export Docker image as tarball
        if: ${{ inputs.is-fork-pr }}
        env:
          GIT_SHA: ${{ github.sha }}
          LOCAL_TAG_PREFIX: ${{ matrix.local-tag-prefix }}
          TARBALL_NAME: ${{ matrix.tarball-name }}
        run: |
          docker save "${LOCAL_TAG_PREFIX}:${GIT_SHA}" | gzip > "/tmp/${TARBALL_NAME}"
          ls -lh "/tmp/${TARBALL_NAME}"

      - name: Upload Docker image artifact
        if: ${{ inputs.is-fork-pr }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: ${{ matrix.artifact-name }}
          path: /tmp/${{ matrix.tarball-name }}
          retention-days: 1
          compression-level: 0 # Already gzipped

  # E2E tests - runs all e2e test suites in parallel
  # Uses matrix strategy to run API, UI (sharded), and Vault tests concurrently
  platform-e2e-tests:
    name: Platform E2E Tests (${{ matrix.name }})
    needs: [platform-e2e-build]
    # Run even when platform-e2e-build is skipped (on PRs) so job succeeds rather than being skipped
    if: ${{ !cancelled() }}
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: API
            runner: e2e-runner-16cpu
            projects: api
            shard: ""
            extra_args: ""
            artifact: blob-report-api
          # UI tests - sharded across 3 parallel jobs
          # Tests tagged @firefox/@webkit are excluded here and run in a dedicated sequential job
          - name: UI 1/3
            runner: e2e-runner-16cpu
            projects: chromium --project=identity-providers
            shard: "--shard=1/3"
            extra_args: "--grep-invert '@firefox|@webkit'"
            artifact: blob-report-ui-1
          - name: UI 2/3
            runner: e2e-runner-16cpu
            projects: chromium --project=identity-providers
            shard: "--shard=2/3"
            extra_args: "--grep-invert '@firefox|@webkit'"
            artifact: blob-report-ui-2
          - name: UI 3/3
            runner: e2e-runner-16cpu
            projects: chromium --project=identity-providers
            shard: "--shard=3/3"
            extra_args: "--grep-invert '@firefox|@webkit'"
            artifact: blob-report-ui-3
          # Firefox tests - run sequentially to avoid race conditions on shared backend state
          - name: UI Firefox
            runner: e2e-runner-16cpu
            projects: firefox
            shard: ""
            extra_args: "--grep '@firefox' --workers=1"
            artifact: blob-report-ui-firefox
          # Webkit tests - run sequentially to avoid race conditions on shared backend state
          - name: UI Webkit
            runner: e2e-runner-16cpu
            projects: webkit
            shard: ""
            extra_args: "--grep '@webkit' --workers=1"
            artifact: blob-report-ui-webkit
          # Vault tests - isolated to avoid race conditions with secrets manager switching
          - name: Vault
            runner: e2e-runner-16cpu
            projects: credentials-with-vault
            shard: ""
            extra_args: ""
            artifact: blob-report-vault
    steps:
      - name: Checkout repository
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Setup environment
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: ./.github/actions/setup-env
        with:
          working-directory: ./platform

      - name: Load platform image
        id: load-platform-image
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: ./.github/actions/load-platform-image
        with:
          is-fork-pr: ${{ inputs.is-fork-pr }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Load MCP server base image
        id: load-mcp-server-base-image
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: ./.github/actions/load-mcp-server-base-image
        with:
          is-fork-pr: ${{ inputs.is-fork-pr }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Archestra Platform
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: ./.github/actions/setup-archestra-platform
        with:
          kind-config-path: .github/kind.yaml
          kind-cluster-name: archestra-ci-cluster
          helm-values-path: .github/values-ci.yaml
          deploy-e2e-dependencies: "true"
          build-platform-image: "false"
          platform-image-tag: ${{ steps.load-platform-image.outputs.image-tag }}
          platform-context: ./platform
          mcp-server-base-image-tag: ${{ steps.load-mcp-server-base-image.outputs.image-tag }}

      - name: Run E2E tests
        id: e2e
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: ./.github/actions/run-e2e-tests
        with:
          projects: ${{ matrix.projects }}
          shard: ${{ matrix.shard }}
          extra_args: ${{ matrix.extra_args }}

      - name: Upload blob report
        if: ${{ inputs.should-skip-running-and-always-succeed != true && !cancelled() }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: ${{ matrix.artifact }}
          path: platform/e2e-tests/blob-report/
          retention-days: 1

      - name: Show logs on failure or flaky tests
        if: failure() || steps.e2e.outputs.has_flaky_tests == 'true'
        run: |
          echo "=== Kubernetes Pods ==="
          kubectl get pods -o wide

          echo "=== Kubernetes Services ==="
          kubectl get services

          echo "=== Archestra Platform Logs ==="
          kubectl logs -l app.kubernetes.io/name=archestra-platform --tail=200

          echo "=== PostgreSQL Logs ==="
          kubectl logs -l app.kubernetes.io/name=postgresql --tail=200

          echo "=== WireMock Logs ==="
          kubectl logs -l app=e2e-tests-wiremock --tail=200 2>/dev/null || true

          echo "=== Keycloak Logs ==="
          kubectl logs -l app.kubernetes.io/name=keycloak --tail=200 2>/dev/null || true

          echo "=== Vault Logs ==="
          kubectl logs -l app.kubernetes.io/name=vault --tail=200 2>/dev/null || true

  # Quickstart E2E tests - validates docker run quickstart instructions work correctly
  # Runs the mcp-install.spec.ts test against the platform started via docker run
  platform-quickstart-e2e-tests:
    name: Platform E2E Tests (Quickstart)
    needs: [platform-e2e-build]
    if: ${{ !cancelled() }}
    runs-on: e2e-runner-16cpu
    permissions:
      contents: read
      packages: read
    steps:
      - name: Checkout repository
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Setup environment
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: ./.github/actions/setup-env
        with:
          working-directory: ./platform

      - name: Load platform image
        id: load-platform-image
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: ./.github/actions/load-platform-image
        with:
          is-fork-pr: ${{ inputs.is-fork-pr }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      # Note: We intentionally don't load/use a custom MCP server base image for quickstart tests.
      # The embedded Kind cluster inside the quickstart container cannot easily access images
      # loaded on the host Docker daemon. The regular e2e tests (platform-e2e-tests) already
      # validate the MCP server base image with proper Kind image loading.
      # Quickstart tests use the default public MCP server base image.

      - name: Start platform in quickstart mode
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        env:
          PLATFORM_IMAGE_TAG: ${{ steps.load-platform-image.outputs.image-tag }}
        run: |
          echo "Starting Archestra platform in quickstart mode..."

          # Create named volumes for data persistence
          docker volume create archestra-ci-postgres-data || true
          docker volume create archestra-ci-app-data || true

          # Start the platform container
          # Note: Uses the public MCP server base image with 'latest' tag because:
          # 1. The embedded Kind cluster cannot easily access images loaded on the host Docker daemon
          # 2. Release-please bumps the version in config.ts before the image is published,
          #    causing failures when running on release PRs (the new version doesn't exist yet)
          # Using 'latest' ensures the image is always available regardless of version bumps
          docker run -d \
            --name archestra-quickstart \
            -p 9000:9000 \
            -p 3000:3000 \
            -e ARCHESTRA_QUICKSTART=true \
            -e ARCHESTRA_ORCHESTRATOR_MCP_SERVER_BASE_IMAGE=europe-west1-docker.pkg.dev/friendly-path-465518-r6/archestra-public/mcp-server-base:latest \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v archestra-ci-postgres-data:/var/lib/postgresql/data \
            -v archestra-ci-app-data:/app/data \
            "${PLATFORM_IMAGE_TAG}"

          echo "Container started, waiting for platform to be ready..."

      - name: Wait for platform to be healthy
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: |
          echo "Waiting for platform services to be healthy..."

          # Wait for backend health endpoint (max 3 minutes)
          # Use 127.0.0.1 instead of localhost to avoid IPv6 issues with Docker port mapping
          echo "Checking backend health..."
          for i in {1..90}; do
            if curl -sf http://127.0.0.1:9000/health > /dev/null 2>&1; then
              echo "Backend is healthy!"
              break
            fi
            echo "Waiting for backend... (attempt $i/90)"
            sleep 2
          done

          # Verify backend is accessible
          if ! curl -sf http://127.0.0.1:9000/health; then
            echo "Backend health check failed after 3 minutes"
            docker logs archestra-quickstart --tail=200
            exit 1
          fi

          # Wait for frontend (max 1 minute - should be quick after backend is ready)
          echo "Checking frontend health..."
          for i in {1..30}; do
            if curl -sf http://127.0.0.1:3000/ > /dev/null 2>&1; then
              echo "Frontend is healthy!"
              break
            fi
            echo "Waiting for frontend... (attempt $i/30)"
            sleep 2
          done

          # Verify frontend is accessible
          if ! curl -sf http://127.0.0.1:3000/; then
            echo "Frontend health check failed after 1 minute"
            docker logs archestra-quickstart --tail=200
            exit 1
          fi

          echo "All services are ready!"

      - name: Create e2e test env file
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: |
          # Use 127.0.0.1 instead of localhost to avoid IPv6 issues with Docker
          echo "E2E_UI_BASE_URL=http://127.0.0.1:3000" > /tmp/quickstart-e2e.env
          echo "E2E_API_BASE_URL=http://127.0.0.1:9000" >> /tmp/quickstart-e2e.env
          cat /tmp/quickstart-e2e.env

      - name: Run quickstart E2E tests
        id: e2e
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: ./.github/actions/run-e2e-tests
        with:
          projects: chromium
          # Self-hosted: MCP install from catalog test (other mcp-install tests have flakiness issues)
          # Origin error handling: auth origin validation and error UX tests
          extra_args: "tests/ui/mcp-install.spec.ts tests/ui/auth-origin.spec.ts --grep 'Self-hosted|Origin error handling'"
          env_file: /tmp/quickstart-e2e.env

      - name: Upload blob report
        if: ${{ inputs.should-skip-running-and-always-succeed != true && !cancelled() }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: blob-report-quickstart
          path: platform/e2e-tests/blob-report/
          retention-days: 1

      - name: Show platform logs on failure
        if: failure()
        run: |
          echo "=== Archestra Quickstart Container Logs ==="
          docker logs archestra-quickstart --tail=500 2>&1 || echo "Could not get container logs"

          echo "=== Docker Container Status ==="
          docker ps -a

          echo "=== Docker Volumes ==="
          docker volume ls

      - name: Cleanup
        if: always()
        run: |
          docker stop archestra-quickstart 2>/dev/null || true
          docker rm archestra-quickstart 2>/dev/null || true
          docker volume rm archestra-ci-postgres-data 2>/dev/null || true
          docker volume rm archestra-ci-app-data 2>/dev/null || true

  # Vault K8s E2E tests - validates platform starts when DB URL is sourced from Vault via K8s auth
  platform-vault-k8s-e2e-tests:
    name: Platform E2E Tests (Vault K8s)
    needs: [platform-e2e-build]
    if: ${{ !cancelled() }}
    runs-on: e2e-runner-16cpu
    permissions:
      contents: read
      packages: read
    steps:
      - name: Checkout repository
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Setup environment
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: ./.github/actions/setup-env
        with:
          working-directory: ./platform

      - name: Load platform image
        id: load-platform-image
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: ./.github/actions/load-platform-image
        with:
          is-fork-pr: ${{ inputs.is-fork-pr }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Kind cluster
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: ./.github/actions/install-kind-cluster

      - name: Load Docker image into Kind
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        env:
          PLATFORM_IMAGE_TAG: ${{ steps.load-platform-image.outputs.image-tag }}
        run: kind load docker-image "${PLATFORM_IMAGE_TAG}" --name archestra-ci-cluster

      - name: Deploy e2e-tests Helm chart (Vault only, K8s auth enabled)
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: |
          helm install e2e-tests platform/helm/e2e-tests \
            --set vault.enabled=true \
            --set vault.k8sAuth.enabled=true \
            --set vault.k8sAuth.boundServiceAccountName=archestra-platform \
            --set vault.k8sAuth.boundServiceAccountNamespace=default \
            --set 'vault.secrets[0].path=kv/archestra/config' \
            --set 'vault.secrets[0].data.dburl=postgresql://archestra:vault_e2e_custom_pw@archestra-platform-postgresql:5432/archestra_dev' \
            --set 'vault.secrets[0].data.dummy_var=hello-from-vault' \
            --set wiremock.enabled=false \
            --set keycloak.enabled=false

      - name: Wait for Vault to be ready
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: |
          echo "Waiting for Vault pod to be ready..."
          kubectl wait --for=condition=Ready pod/vault --timeout=120s
          echo "Vault pod is ready"

      - name: Deploy platform with Vault K8s values
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        env:
          PLATFORM_IMAGE_TAG: ${{ steps.load-platform-image.outputs.image-tag }}
        run: |
          helm install archestra-platform platform/helm/archestra \
            --values .github/values-ci-vault-k8s.yaml \
            --set "archestra.image=${PLATFORM_IMAGE_TAG}" \
            --atomic --timeout=4m

      - name: Wait for platform to be healthy
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: |
          echo "Waiting for platform pods to be ready..."
          kubectl wait --for=condition=Ready pods -l app.kubernetes.io/name=archestra-platform --timeout=90s
          echo "Platform pods are ready"

          echo "Verifying backend is accessible..."
          curl --retry 10 --retry-delay 2 --retry-connrefused http://localhost:9000/health || (echo "Backend not accessible" && exit 1)
          echo "Backend is healthy"

      - name: Run Vault K8s E2E tests
        id: e2e
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: ./.github/actions/run-e2e-tests
        with:
          projects: vault-k8s

      - name: Upload blob report
        if: ${{ inputs.should-skip-running-and-always-succeed != true && !cancelled() }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: blob-report-vault-k8s
          path: platform/e2e-tests/blob-report/
          retention-days: 1

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Kubernetes Pods ==="
          kubectl get pods -o wide

          echo "=== Kubernetes Services ==="
          kubectl get services

          echo "=== Archestra Platform Logs ==="
          kubectl logs -l app.kubernetes.io/name=archestra-platform --tail=200

          echo "=== Vault Logs ==="
          kubectl logs vault --tail=200 2>/dev/null || true

          echo "=== PostgreSQL Logs ==="
          kubectl logs -l app.kubernetes.io/name=postgresql --tail=200 2>/dev/null || true

          echo "=== Describe Platform Pod ==="
          kubectl describe pod -l app.kubernetes.io/name=archestra-platform

  # Merge all Playwright reports into a single HTML report
  platform-e2e-merge-reports:
    name: Merge E2E Test Reports
    needs: [platform-e2e-tests, platform-quickstart-e2e-tests, platform-vault-k8s-e2e-tests]
    if: ${{ always() && !cancelled() && inputs.should-skip-running-and-always-succeed != true }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write # Required for playwright-report-summary to comment on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Setup environment
        uses: ./.github/actions/setup-env
        with:
          working-directory: ./platform

      - name: Download all blob reports
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          path: platform/e2e-tests/blob-reports
          pattern: blob-report-*
          merge-multiple: true

      - name: Merge reports
        working-directory: ./platform/e2e-tests
        env:
          PLAYWRIGHT_JSON_OUTPUT_NAME: results.json
        run: |
          echo "=== Contents of blob-reports directory ==="
          ls -la ./blob-reports/ || echo "blob-reports directory not found"
          echo "=== Merging reports ==="
          pnpm exec playwright merge-reports --reporter=html,json ./blob-reports
          echo "=== Files created after merge ==="
          ls -la
          ls -la ./playwright-report/ || echo "playwright-report directory not created"

      - name: Upload merged Playwright report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: playwright-report
          path: platform/e2e-tests/playwright-report/
          # Shorter retention for success, full retention for failures
          retention-days: ${{ needs.platform-e2e-tests.result == 'success' && 7 || 30 }}

      - name: Write test summary
        if: always()
        uses: daun/playwright-report-summary@be9e270edd5ad86038604d3caa84a819a6ff6fed # v3.10.0
        with:
          report-file: platform/e2e-tests/results.json
          job-summary: true

  # Scan Docker images for CVEs using Docker Scout
  # Runs on merge queue only (not on PRs) to reduce CI time
  # NOTE: Skipped for fork PRs because GitHub doesn't expose repository secrets
  docker-image-scanning:
    name: Docker Image Scanning (${{ matrix.name }})
    needs: [platform-e2e-build]
    # Run even when platform-e2e-build is skipped (on PRs) so job succeeds rather than being skipped
    if: ${{ !cancelled() }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Platform
            runner: ubuntu-latest
            image-source: platform-e2e-build
            context: ""
            dockerfile: ""
          - name: MCP Server Base
            runner: blacksmith-4vcpu-ubuntu-2404
            image-source: build
            context: ./platform/mcp_server_docker_image
            dockerfile: ./platform/mcp_server_docker_image/Dockerfile
    permissions:
      contents: read
      packages: read
    steps:
      - name: Checkout repository
        if: ${{ github.event_name == 'merge_group' }}
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      # Platform image: Load from GHCR or artifact (already built by platform-e2e-build)
      - name: Load platform image
        id: load-platform-image
        if: ${{ github.event_name == 'merge_group' && matrix.image-source == 'platform-e2e-build' }}
        uses: ./.github/actions/load-platform-image
        with:
          is-fork-pr: ${{ inputs.is-fork-pr }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      # Other images: Build locally for scanning (single arch, no push)
      - name: Setup Blacksmith Builder
        if: ${{ github.event_name == 'merge_group' && matrix.image-source == 'build' }}
        uses: useblacksmith/setup-docker-builder@f9b57e1c7d5a57eed0b5609e1ffeadbf3bb0b726 # v1.1.0

      - name: Build image for scanning
        id: build-image
        if: ${{ github.event_name == 'merge_group' && matrix.image-source == 'build' }}
        uses: useblacksmith/build-push-action@30c71162f16ea2c27c3e21523255d209b8b538c1 # v2
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64
          push: false
          load: true
          tags: scan-target:${{ github.sha }}

      # Determine the image tag to scan
      - name: Set image tag
        id: image-tag
        if: ${{ github.event_name == 'merge_group' }}
        env:
          IMAGE_SOURCE: ${{ matrix.image-source }}
          PLATFORM_IMAGE_TAG: ${{ steps.load-platform-image.outputs.image-tag }}
          GIT_SHA: ${{ github.sha }}
        run: |
          if [ "${IMAGE_SOURCE}" == "platform-e2e-build" ]; then
            echo "tag=${PLATFORM_IMAGE_TAG}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=scan-target:${GIT_SHA}" >> "$GITHUB_OUTPUT"
          fi

      - name: Scan image for CVEs
        if: ${{ github.event_name == 'merge_group' && !inputs.is-fork-pr }}
        uses: ./.github/actions/scan-docker-image
        with:
          image: ${{ steps.image-tag.outputs.tag }}
          dockerhub-user: ${{ secrets.DOCKER_USERNAME }}
          dockerhub-password: ${{ secrets.DOCKER_PASSWORD }}

  helm-chart-linting-and-tests:
    name: Helm Chart Linting and Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: ./platform/helm/archestra
    steps:
      - name: Checkout project
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Linting
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: helm lint .

      - name: Tests
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: |
          helm plugin install https://github.com/helm-unittest/helm-unittest --version v1.0.3
          helm unittest .

      - name: helm package
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        # NOTE: can't use ${{ github.sha }} for version here because it's not a valid version number
        # and helm package explicitly checks this
        run: |
          helm package . --version v0.0.1 --app-version v0.0.1
