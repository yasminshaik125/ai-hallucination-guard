name: On commits to main

on:
  push:
    branches:
      - main
  # Allow manual triggering of the workflow
  workflow_dispatch:

# Set default permissions to empty to enforce least privilege
# Each job will explicitly declare the permissions it needs
permissions: {}

jobs:
  build-staging-image:
    name: Build Platform Staging Docker Image
    runs-on: blacksmith-16vcpu-ubuntu-2404
    permissions:
      contents: read
      id-token: write # Required for Workload Identity Federation
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Authenticate to Google Artifact Registry
        uses: ./.github/actions/auth-to-gar
        with:
          service_account: ${{ secrets.DEVELOPMENT_OAUTH_PROXY_RELEASER_GCP_SERVICE_ACCOUNT_NAME }}
          workload_identity_provider: ${{ secrets.DEVELOPMENT_OAUTH_PROXY_RELEASER_GCP_WORKLOAD_IDENTITY_PROVIDER_IDENTIFIER }}

      - name: Install gke-gcloud-auth-plugin
        run: gcloud components install gke-gcloud-auth-plugin

      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials archestra-staging \
            --zone us-central1-a --project friendly-path-465518-r6

      - name: Extract previous version static assets
        run: |
          PREV_TAG=$(kubectl get deployment archestra-platform -n archestra \
            -o jsonpath='{.spec.template.spec.containers[0].image}' 2>/dev/null \
            | cut -d: -f2) || true

          mkdir -p platform/prev-static-assets
          if [ -n "$PREV_TAG" ] && [ "$PREV_TAG" != "$GITHUB_SHA_VALUE" ]; then
            PREV_IMAGE="europe-west1-docker.pkg.dev/friendly-path-465518-r6/archestra-public/platform:${PREV_TAG}"
            echo "Pulling previous image: $PREV_IMAGE"
            docker pull "$PREV_IMAGE" || { echo "Warning: Failed to pull previous image"; true; }
            CID=$(docker create "$PREV_IMAGE" 2>/dev/null) || true
            if [ -n "$CID" ]; then
              # Extract from /static-assets-source/ which has ONLY that build's chunks (not accumulated)
              echo "Extracting previous static assets from container $CID"
              docker cp "${CID}:/static-assets-source/." platform/prev-static-assets/ || echo "Warning: Failed to copy previous assets"
              docker rm "$CID"
              echo "Successfully extracted previous static assets"
            else
              echo "No previous container created, skipping asset extraction"
            fi
          else
            echo "No previous version to extract (PREV_TAG: $PREV_TAG)"
          fi
        env:
          GITHUB_SHA_VALUE: ${{ github.sha }}

      # NOTE: only build on amd64 for now as our staging environment runs on amd64
      # if we will need to support arm64, we should follow the pattern we do in
      # .github/workflows/build-dockerhub-image.yml and do a matrix build so that we are build
      # on both amd64 and arm64 using native arch (to massively speed up the builds)
      - name: Build Docker image
        uses: ./.github/actions/build-platform-docker-image
        with:
          context: ./platform
          push: "true"
          platforms: linux/amd64
          version: ${{ github.sha }}
          tags: europe-west1-docker.pkg.dev/friendly-path-465518-r6/archestra-public/platform:${{ github.sha }}
          turbo-team: ${{ secrets.TURBOREPO_REMOTE_CACHING_TEAM }}
          turbo-token: ${{ secrets.TURBOREPO_REMOTE_CACHING_TOKEN }}
          sentry-auth-token: ${{ secrets.PLATFORM_NEXTJS_SOURCE_MAP_SENTRY_AUTH_TOKEN }}

  deploy-to-staging:
    name: Deploy to staging
    runs-on: ubuntu-latest
    needs: build-staging-image
    permissions:
      contents: read
      id-token: write # Required for Workload Identity Federation
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@6fc4af4b145ae7821d527454aa9bd537d1f2dc5f # v2.1.7
        with:
          service_account: ${{ secrets.DEVELOPMENT_OAUTH_PROXY_RELEASER_GCP_SERVICE_ACCOUNT_NAME }}
          workload_identity_provider: ${{ secrets.DEVELOPMENT_OAUTH_PROXY_RELEASER_GCP_WORKLOAD_IDENTITY_PROVIDER_IDENTIFIER }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@aa5489c8933f4cc7a4f7d45035b3b1440c9c10db # v3.0.1

      - name: Install gke-gcloud-auth-plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin

      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials archestra-staging \
            --zone us-central1-a \
            --project friendly-path-465518-r6

      - name: Deploy to staging
        run: |
          helm upgrade archestra-platform \
            ./platform/helm/archestra \
            --install \
            --namespace archestra \
            --create-namespace \
            --set archestra.image=europe-west1-docker.pkg.dev/friendly-path-465518-r6/archestra-public/platform:${{ github.sha }} \
            --set archestra.databaseUrl="${{ secrets.ARCHESTRA_STAGING_DATABASE_URL }}" \
            --set archestra.env.ARCHESTRA_FRONTEND_URL="https://frontend.archestra.dev" \
            --set archestra.env.ARCHESTRA_API_BASE_URL="https://backend.archestra.dev" \
            --set archestra.env.ARCHESTRA_AUTH_COOKIE_DOMAIN=".archestra.dev" \
            --set archestra.env.ARCHESTRA_METRICS_SECRET="${{ secrets.ARCHESTRA_STAGING_METRICS_SECRET }}" \
            --set archestra.env.ARCHESTRA_OTEL_EXPORTER_OTLP_ENDPOINT="${{ secrets.ARCHESTRA_STAGING_OTEL_EXPORTER_OTLP_ENDPOINT }}" \
            --set archestra.env.ARCHESTRA_AUTH_SECRET="${{ secrets.ARCHESTRA_STAGING_AUTH_SECRET }}" \
            --set archestra.env.ARCHESTRA_AUTH_ADMIN_EMAIL="${{ secrets.ARCHESTRA_STAGING_AUTH_ADMIN_EMAIL }}" \
            --set archestra.env.ARCHESTRA_AUTH_ADMIN_PASSWORD="${{ secrets.ARCHESTRA_STAGING_AUTH_ADMIN_PASSWORD }}" \
            --set archestra.env.ARCHESTRA_SENTRY_ENVIRONMENT="archestra.dev" \
            --set archestra.env.ARCHESTRA_SENTRY_BACKEND_DSN="${{ secrets.ARCHESTRA_STAGING_SENTRY_BACKEND_DSN }}" \
            --set archestra.env.ARCHESTRA_SENTRY_FRONTEND_DSN="${{ secrets.ARCHESTRA_STAGING_SENTRY_FRONTEND_DSN }}" \
            --set archestra.env.ARCHESTRA_ENTERPRISE_LICENSE_ACTIVATED="true" \
            --set archestra.env.FEATURES_BROWSER_STREAMING_ENABLED="true" \
            --set archestra.env.ARCHESTRA_AGENTS_INCOMING_EMAIL_PROVIDER="outlook" \
            --set archestra.env.ARCHESTRA_AGENTS_INCOMING_EMAIL_OUTLOOK_TENANT_ID="${{ secrets.ARCHESTRA_STAGING_OUTLOOK_TENANT_ID }}" \
            --set archestra.env.ARCHESTRA_AGENTS_INCOMING_EMAIL_OUTLOOK_CLIENT_ID="${{ secrets.ARCHESTRA_STAGING_OUTLOOK_CLIENT_ID }}" \
            --set archestra.env.ARCHESTRA_AGENTS_INCOMING_EMAIL_OUTLOOK_CLIENT_SECRET="${{ secrets.ARCHESTRA_STAGING_OUTLOOK_CLIENT_SECRET }}" \
            --set archestra.env.ARCHESTRA_AGENTS_INCOMING_EMAIL_OUTLOOK_MAILBOX_ADDRESS="agents@archestraai.onmicrosoft.com" \
            --set archestra.env.ARCHESTRA_AGENTS_INCOMING_EMAIL_OUTLOOK_WEBHOOK_URL="https://backend.archestra.dev/api/webhooks/incoming-email" \
            --set archestra.env.ARCHESTRA_CHAT_DEFAULT_PROVIDER="anthropic" \
            --set archestra.env.ARCHESTRA_CHAT_DEFAULT_MODEL="claude-opus-4-5-20251101" \
            --set archestra.env.ARCHESTRA_CHAT_ANTHROPIC_API_KEY="${{ secrets.ARCHESTRA_STAGING_CHAT_ANTHROPIC_API_KEY }}" \
            --set archestra.env.ARCHESTRA_KNOWLEDGE_GRAPH_PROVIDER="lightrag" \
            --set archestra.env.ARCHESTRA_KNOWLEDGE_GRAPH_LIGHTRAG_API_URL="http://lightrag.knowledge-graph.svc.cluster.local:9621" \
            --set archestra.env.ARCHESTRA_CHATOPS_MS_TEAMS_ENABLED="true" \
            --set archestra.env.ARCHESTRA_CHATOPS_MS_TEAMS_APP_ID="${{ secrets.ARCHESTRA_STAGING_MS_TEAMS_APP_ID }}" \
            --set archestra.env.ARCHESTRA_CHATOPS_MS_TEAMS_APP_SECRET="${{ secrets.ARCHESTRA_STAGING_MS_TEAMS_APP_SECRET }}" \
            --set archestra.env.ARCHESTRA_CHATOPS_MS_TEAMS_TENANT_ID="${{ secrets.ARCHESTRA_STAGING_MS_TEAMS_TENANT_ID }}" \
            --values .github/values-staging.yaml \
            --wait
