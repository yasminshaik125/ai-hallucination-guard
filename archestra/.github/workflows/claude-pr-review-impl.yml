# Reusable workflow for Claude PR review implementation.
# Called by claude-pr-review.yml with user-specific OAuth tokens.
name: Claude PR Review (Implementation)

on:
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: number
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        required: true

jobs:
  pr-review:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: PR Review with Claude
        uses: anthropics/claude-code-action@1b8ee3b94104046d71fde52ec3557651ad8c0d71 # v1.0.29
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          # Use sticky comments to reduce notification clutter by updating one comment
          use_sticky_comment: true
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ inputs.pr_number }}

            Perform a comprehensive code review with the following focus areas:

            1. **Code Quality**
               - Clean code principles and best practices
               - Proper error handling and edge cases
               - Code readability and maintainability

            2. **Security**
               - Check for potential security vulnerabilities
               - Validate input sanitization
               - Review authentication/authorization logic

            3. **Performance**
               - Identify potential performance bottlenecks
               - Review database queries for efficiency
               - Check for memory leaks or resource issues

            4. **Testing**
               - Verify adequate test coverage
               - Review test quality and edge cases
               - Check for missing test scenarios

            Be concise. Only mention issues if you find them - don't pad with "everything looks good" comments.
            Use inline comments for specific issues.
          claude_args: |
            --model claude-opus-4-5-20251101
            --allowedTools Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)
